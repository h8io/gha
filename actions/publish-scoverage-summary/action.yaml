name: Publish scoverage summary
author: Eshu
description: Publish scoverage summaries generated by sbt-scoverage-summary plugin as a pull request comment

inputs:
  GITHUB_TOKEN:
    description: secrets.GITHUB_TOKEN
    required: true

env:
  SUMMARY_FILE: scoverage-summary.md
  REPORT_FILE: scoverage-report.zip

runs:
  using: composite
  steps:
    - name: Create scoverage summary
      if: ${{ github.event.pull_request }}
      env:
        GITHUB_TOKEN: ${{ inputs.GITHUB_TOKEN }}
      shell: bash
      run: |
        set -euo pipefail
        shopt -s globstar
        if [ -z "${GITHUB_TOKEN:-}" ]; then
          echo "GitHub token undefined or empty" >&2
          exit 1
        fi
        echo "# ${{ github.event.pull_request.head.sha }}" > $SUMMARY_FILE
        cat $(ls ./**/target/**/scoverage-summary/gfm.md | sort) >> $SUMMARY_FILE
    - name: Create coverage archive (zip)
      id: coverage-archive
      shell: bash
      run: |
        set -euo pipefail
        mapfile -d '' dirs < <(find . -path '*/target/scala-*/scoverage-report' -type d -print0)
        (( ${#dirs[@]} )) || { echo "No scoverage-report directories found"; exit 1; }
        zip -r $REPORT_FILE "${dirs[@]}"
    - name: Upload coverage artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.coverage-archive.outputs.NAME }}
        path: $REPORT_FILE
        retention-days: 3
    - name: Publish scoverage summary
      shell: bash
      run: |
        echo "" >> scoverage-summary.md
        echo "[Download full HTML report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)" >> $SUMMARY_FILE
        gh pr comment "${{ github.event.pull_request.number }}" --body-file $SUMMARY_FILE
