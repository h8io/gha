name: Publish scoverage summary
author: Eshu
description: Publish scoverage summaries generated by sbt-scoverage-summary plugin as a pull request comment

inputs:
  GITHUB_TOKEN:
    description: secrets.GITHUB_TOKEN
    required: true

runs:
  using: composite
  steps:
    - name: Publish scoverage summary
      if: ${{ github.event.pull_request }}
      env:
        GITHUB_TOKEN: ${{ inputs.GITHUB_TOKEN }}
      shell: bash
      run: |
        set -euo pipefail
        shopt -s globstar
        if [ -z "${GITHUB_TOKEN:-}" ]; then
          echo "GitHub token undefined or empty" >&2
          exit 1
        fi
        SUMMARY_FILE=scoverage-summary.md
        echo "# ${{ github.event.pull_request.head.sha }}" > $SUMMARY_FILE
        cat $(ls ./**/target/**/scoverage-summary/gfm.md | sort) >> $SUMMARY_FILE
        gh pr comment "${{ github.event.pull_request.number }}" --body-file $SUMMARY_FILE
